---
title: "Mapping bias and correlation following latidunal gradient"
output: html_document
date: "2025-08-08"
---

---

## Library

```{r, include=FALSE}

library(tidyverse)
library(rnaturalearth)
library(tidyr)
library(leaflet)
library(sf)
library(ggmap)
library(ggplot2)
library(plyr)
library(dplyr)
library(sf)
library(RColorBrewer)
library(ggpubr)
library(scales)

```

## LOADING FILES

```{r, include=FALSE}

shp_moy <- st_read(file.path("carte","data","sdmean_mtmsi.shp")) 
shp_bias <- st_read(file.path("carte","data","bias_all.shp")) 
shp_bias_rel <- st_read(file.path("carte","data","bias_rel_all.shp")) 
shp_cor <- st_read(file.path("carte","data", "cor_all.shp")) 

  # country borders #
worldmap <- ne_countries(scale = 'medium', type = 'map_units',
                         returnclass = 'sf')
```

## MAPPING

```{r, include=FALSE}


                                      ###### MEAN MAX SD ######
  pMOY <- ggplot() +
  geom_sf(data=worldmap)+
  geom_sf(data=shp_moy, aes(fill = meanmax), colour=NA)+
  scale_fill_gradient2(low="white", high="royalblue3",
                       name="Mean snow depth maxima (m)", lim=c(0,2.2),
                       guide = guide_colorbar(title.position="top", title.hjust=0.5, 
                                              barwidth = 10, barheight = 0.5, ticks.colour="black"))+
  coord_sf(xlim = c(0, 32), ylim = c(44, 71))+ 
  theme_light()+
  theme(axis.text = element_text(size=15), legend.title = element_text(size=18), 
        legend.text = element_text(size=15), legend.position = "bottom",
        panel.background = element_rect(fill = "lightsteelblue2"))

                                      ###### BIAS ######

  pBIAS <- ggplot() +
  geom_sf(data=worldmap)+
  geom_sf(data=shp_bias, aes(fill = valeur), colour=NA)+
  scale_fill_gradient2(low="red", high="blue", mid="white", midpoint=0, 
                       name="Absolute bias (m)", lim=c(-1.5,1.5), breaks=c(-1.5,-0.8,0,0.8, 1.5),
                       guide = guide_colorbar(title.position="top", title.hjust=0.5, 
                                              barwidth = 10, barheight = 0.5, ticks.colour="black"))+
  coord_sf(xlim = c(0, 32), ylim = c(44, 71))+ 
  theme_light()+
  theme(axis.text = element_text(size=15), legend.title = element_text(size=18), 
        legend.text = element_text(size=15), legend.position = "bottom",
        panel.background = element_rect(fill = "lightsteelblue2"))


                                      ###### RELATIVE BIAS ######
  
  pBIASrel <- ggplot() +
  geom_sf(data=worldmap)+
  geom_sf(data=shp_bias_rel, aes(fill = valeur), colour=NA)+
  scale_fill_gradient2(low="red", high="blue", mid="white", midpoint=0, 
                       name="Relative bias (%)", lim=c(-180,180),#c(-230,230)
                       guide = guide_colorbar(title.position="top", title.hjust=0.5, 
                                              barwidth = 10, barheight = 0.5, ticks.colour="black"))+
  coord_sf(xlim = c(0, 32), ylim = c(44, 71))+ 
  theme_light()+
  theme(axis.text = element_text(size=15), legend.title = element_text(size=18), 
        legend.text = element_text(size=15), legend.position = "bottom",
        panel.background = element_rect(fill = "lightsteelblue2"))


                                      ###### CORRELATION ######
  
  pCOR <- ggplot() +
  geom_sf(data=worldmap)+
  geom_sf(data=shp_cor, aes(fill = valeur), colour=NA)+ #
  scale_fill_gradient2(low="white", high="darkgreen", mid="#ccece6", midpoint=0.5, 
                       lim=c(-0.1,1), name="Correlation", breaks=c(0,0.2,0.4,0.6,0.8,1),
                       guide = guide_colorbar(title.position="top", title.hjust=0.5, 
                                              barwidth = 10, barheight = 0.5, ticks.colour="black"))+ 
  coord_sf(xlim = c(0, 32), ylim = c(44, 71))+ 
  theme_light()+
  theme(axis.text = element_text(size=15), legend.title = element_text(size=18), 
        legend.text = element_text(size=15), legend.position = "bottom",
        panel.background = element_rect(fill = "lightsteelblue2"))
  

png(file.path("carte","map_multi2.jpg"), 
    width = 20, height = 30, units = "in", res=300)
ggarrange(pMOY, pBIASrel, pBIAS, pCOR, nrow = 2, ncol=2)
dev.off()


```

